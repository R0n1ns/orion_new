<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Chat App</title>
    <style>
        /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        .app-container {
            position: absolute;
            height: 100%;
            width: 100%;
            display: flex;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .chat-list-container {
            width: 30%;
            background-color: #f7f7f7;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #ddd;
            height: 100%;
        }
        .search-bar {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            background-color: #fff;
            display: flex;
            align-items: center;
        }
        .search-icon {
            margin-right: 5px;
        }
        .search-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            outline: none;
        }
        .search-results {
            background-color: #fff;
            border-bottom: 1px solid #ddd;
            max-height: 200px;
            overflow-y: auto;
        }
        .chat-list {
            overflow-y: auto;
            flex-grow: 1;
        }

        /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∏–Ω–∏–π –∫—Ä—É–∂–æ–∫, –µ—Å–ª–∏ —á–∞—Ç –Ω–µ –ø—Ä–æ—á–∏—Ç–∞–Ω */
        .chat-item.unread .blue-circle {
            display: block;
        }
        .chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #0088cc;
            padding: 10px;
            color: white;
            cursor: pointer;
        }
        .header-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .chat-title {
            margin: 0;
            font-size: 1.2rem;
        }

        .chat-body {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            background-color: #f5f5f5;
        }

        .chat-input {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: #fff;
            border-top: 1px solid #ddd;
        }
        .input-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            margin-right: 10px;
        }
        .message-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }
        .message-input::placeholder {
            color: #999;
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .popup-content {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            position: relative;
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: transparent;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }
        /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å –∞–∫–∫–∞—É–Ω—Ç–∞ */
        .account-strip {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background-color: #fff;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            cursor: pointer;
            z-index: 1100;
        }
        /* –ü–æ–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ */
        .edit-field {
            width: 100%;
            padding: 8px;
            margin: 5px 0 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        /* –ö–Ω–æ–ø–∫–∏ */
        .btn-primary {
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            background-color: #007bff;
            color: #fff;
            cursor: pointer;
            margin-right: 10px;
        }
        .btn-secondary {
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            background-color: #6c757d;
            color: #fff;
            cursor: pointer;
        }
        /* –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —á–∞—Ç–∞ */
        .chat-item {
            display: flex;
            align-items: center;
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }

        .chat-item:hover {
            background-color: #f5f5f5;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
            object-fit: cover;
        }

        .chat-info {
            flex-grow: 1;
        }

        .unread-count {
            background-color: #0088cc;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        .search-result-item {
            display: flex;
            align-items: center;
            padding: 10px;
            cursor: pointer;
            gap: 12px;
            transition: background-color 0.2s;
        }

        .search-result-item:hover {
            background-color: #f5f5f5;
        }

        .search-result-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
        }

        .existing-chat-badge {
            margin-left: auto;
            font-size: 0.8rem;
            color: #666;
            padding: 2px 8px;
            border: 1px solid #ddd;
            border-radius: 12px;
        }
        /* –í —Ä–∞–∑–¥–µ–ª–µ —Å—Ç–∏–ª–µ–π –¥–ª—è account-strip */
        .account-strip {
            /* –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ */
            gap: 10px; /* –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø –º–µ–∂–¥—É —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ */
        }

        #logout-btn {
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.2s;
            font-size: 0.9rem;
        }

        #logout-btn:hover {
            background-color: rgba(255, 0, 0, 0.8);
        }

        .blocked-message {
            color: #ff4444;
            font-size: 0.9em;
            margin: 8px 0;
            padding: 4px;
            text-align: center;
            background: #ffeeee;
            border-radius: 4px;
            display: none;
        }

        .blocked .message-input {
            background-color: #fff0f0 !important;
            border-color: #ffcccc !important;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .online-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 8px;
            display: inline-block;
        }
        .online { background-color: #4CAF50; }
        .offline { background-color: #F44336; }
    </style>
</head>
<body>
<div class="app-container">
    <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –∏ –ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div class="chat-list-container">
        <div class="search-bar">
            <span class="search-icon">&#128269;</span>
            <input type="text" placeholder="Search users..." class="search-input" id="search-input">
        </div>
        <div class="search-results" id="search-results"></div>
        <div class="chat-list" id="chat-list"></div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: –æ–∫–Ω–æ —á–∞—Ç–∞ —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ -->
    <div class="chat-container">
        <div class="header" id="chat-header">
            <div class="header-info">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <img src="" alt="User" id="chat-user-photo"
                         style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                    <h2 class="chat-title" id="chat-title"></h2>
                </div>
            </div>
        </div>
        <div class="chat-body" id="chat-body">
            <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è -->
        </div>
        <div class="chat-input" id="chat-input">
            <div class="blocked-message" id="blocked-message">–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã</div>
            <input type="text" class="message-input" placeholder="Type a message..." id="message-input">
            <button class="input-btn send-btn" id="send-btn">Send</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ —á–∞—Ç–∞ -->
<div class="popup-overlay" id="chat-info-modal">
    <div class="popup-content">
        <button class="close-btn" id="chat-info-close">&times;</button>
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="" alt="User" id="chat-info-img"
                 style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover;">
        </div>
        <div id="chat-info-fields" style="text-align: center;">
            <p><strong>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</strong> <span id="chat-info-username"></span></p>
            <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="chat-info-status">–í —Å–µ—Ç–∏</span></p>
            <button class="btn-primary" id="block-toggle-btn">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º -->
<div class="popup-overlay" id="account-info-modal">
    <div class="popup-content">
        <button class="close-btn" id="account-info-close">&times;</button>
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="" alt="Account" id="account-info-img" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover;">
        </div>
        <!-- –ü—Ä–æ—Å–º–æ—Ç—Ä -->
        <div id="account-info-view">
            <p><strong>Mail:</strong> <span id="view-mail"></span></p>
            <p><strong>UserName:</strong> <span id="view-username"></span></p>
            <p><strong>Bio:</strong> <span id="view-bio"></span></p>
            <button class="btn-primary" id="edit-profile-btn">–ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
        </div>
        <!-- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ -->
        <div id="account-info-edit" style="display: none;">
            <label>Mail:</label>
            <input type="email" id="edit-mail" class="edit-field">
            <label>UserName:</label>
            <input type="text" id="edit-username" class="edit-field">
            <label>Bio:</label>
            <textarea id="edit-bio" class="edit-field" rows="3"></textarea>
            <!-- üëá –∫–Ω–æ–ø–∫–∞ —Å–º–µ–Ω—ã —Ñ–æ—Ç–æ -->
            <div style="margin-top: 20px;">
                <button id="change-photo-btn" class="btn-secondary">–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
                <input type="file" accept="image/*" id="file-input" style="display: none;">
            </div>

            <button class="btn-primary" id="save-profile-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn-secondary" id="cancel-edit-btn">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<!-- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å –∞–∫–∫–∞—É–Ω—Ç–∞ -->
<div class="account-strip" id="account-strip">
    <img src="" alt="Profile" id="account-strip-img" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
    <span id="account-strip-name" style="margin-left: 10px;">–ê–∫–∫–∞—É–Ω—Ç</span>
    <!-- –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤—ã—Ö–æ–¥–∞ -->
    <button id="logout-btn" style="margin-left: auto; background: none; border: none; color: #ff4444; cursor: pointer;">
        –í—ã–π—Ç–∏
    </button>
</div>
<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ø–æ WebSocket -->
<div class="popup-overlay" id="server-error-modal">
    <div class="popup-content">
        <button class="close-btn" id="server-error-close">&times;</button>
        <p>–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ä–≤–µ—Ä–æ–º: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –ø–æ WebSocket.</p>
    </div>
</div>

<script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    var chats = [];
    var messages = [];
    var unreadMessages = {}; // { chatId: count }
    var isOnline = false;
    var searchResults = [];
    var chatInfo = {};
    var accountInfo = {};
    var activeChatId = null;
    var ws = null;

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã DOM
    var searchInput = document.getElementById("search-input");
    var searchResultsDiv = document.getElementById("search-results");
    var chatListDiv = document.getElementById("chat-list");
    var chatTitle = document.getElementById("chat-title");
    var chatSubtitle = document.getElementById("chat-subtitle");
    var chatBody = document.getElementById("chat-body");
    var messageInput = document.getElementById("message-input");
    var sendBtn = document.getElementById("send-btn");
    var chatHeader = document.getElementById("chat-header");
    var chatInfoModal = document.getElementById("chat-info-modal");
    var chatInfoClose = document.getElementById("chat-info-close");
    var chatInfoImg = document.getElementById("chat-info-img");
    var chatInfoFields = document.getElementById("chat-info-fields");
    var accountInfoModal = document.getElementById("account-info-modal");
    var accountInfoClose = document.getElementById("account-info-close");
    var accountInfoImg = document.getElementById("account-info-img");
    var accountStrip = document.getElementById("account-strip");
    var accountStripImg = document.getElementById("account-strip-img");
    var accountStripName = document.getElementById("account-strip-name");
    var serverErrorModal = document.getElementById("server-error-modal");
    let activeUserId = null;
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è JWT
    function jwtDecode(token) {
        var parts = token.split('.');
        if (parts.length !== 3) throw new Error("Invalid token");
        var payload = parts[1].replace(/-/g, '+').replace(/_/g, '/');
        var decodedPayload = atob(payload);
        return JSON.parse(decodedPayload);
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ user_id –∏–∑ JWT –≤ cookies
    function getUserIdFromJWT() {
        var tokenCookie = document.cookie.split("; ").find(row => row.startsWith("jwt_token="));
        if (tokenCookie) {
            var jwt = tokenCookie.split("=")[1];
            try {
                var decoded = jwtDecode(jwt);
                return decoded.user_id;
            } catch(e) {
                console.error("Failed to decode JWT:", e);
                return null;
            }
        }
        return null;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∂–∞—Ç–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    function compressImage(imageFile, callback) {
        var reader = new FileReader();
        reader.onload = function(e) {
            var img = new Image();
            img.onload = function() {
                var MAX_WIDTH = 300;
                var scaleSize = MAX_WIDTH / img.width;
                var canvas = document.createElement('canvas');
                canvas.width = MAX_WIDTH;
                canvas.height = img.height * scaleSize;
                var ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                callback(canvas.toDataURL('image/jpeg', 0.7));
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(imageFile);
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ WebSocket
    function sendToServer(message) {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify(message));
        }
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–± –æ—à–∏–±–∫–µ —Å–µ—Ä–≤–µ—Ä–∞
    function showServerErrorModal() {
        serverErrorModal.style.display = "flex";
    }
    // –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    chatHeader.addEventListener("click", function() {
        if (activeChatId) {
            const chat = chats.find(c => c.id === activeChatId);
            if (chat) {
                const targetUser = chat.users.find(u => u.id !== getUserIdFromJWT());
                const blockBtn = document.getElementById("block-toggle-btn");
                blockBtn.dataset.userId = targetUser.id; // –°–æ—Ö—Ä–∞–Ω—è–µ–º userId
                blockBtn.dataset.isBlocked = targetUser.isBlocked;
                blockBtn.textContent = targetUser.isBlocked ? "–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å" : "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å";

                document.getElementById("chat-info-img").src = chat.userPhoto;
                document.getElementById("chat-info-username").textContent = chat.username;
                document.getElementById("chat-info-modal").style.display = "flex";
            }
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    document.getElementById("block-toggle-btn").addEventListener("click", async function() {
        const button = this;
        const userId = button.dataset.userId;
        const isBlocked = button.dataset.isBlocked === "true";

        const endpoint = isBlocked
            ? 'http://localhost:3333/service/api/unblock'
            : 'http://localhost:3333/service/api/block';

        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + getJwtToken()
                },
                body: JSON.stringify({ userId: userId })
            });

            if (response.ok) {
                // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–Ω–æ–ø–∫–∏ –∏ UI
                const newStatus = !isBlocked;
                button.textContent = newStatus ? "–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å" : "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å";
                button.dataset.isBlocked = newStatus.toString();

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —á–∞—Ç–∞ –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
                await checkBlockStatus(); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ input, send –∏ —Ç.–ø.
                await loadChats();        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
            } else {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
        }
    });



    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    function setupWebSocket() {
        var userId = getUserIdFromJWT();
        if (!userId) {
            window.location.href = "/login";
            return;
        }

        ws = new WebSocket("ws://localhost:3333/service/ws");

        ws.onopen = function() {
            console.log("WebSocket connected");
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç—ã –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            loadChats();
        };

        ws.onmessage = function(event) {
            var data = JSON.parse(event.data);
            handleMessage(data);
        };

        ws.onerror = function(error) {
            console.error("WebSocket error:", error);
            showServerErrorModal();
        };

        ws.onclose = function() {
            console.log("WebSocket disconnected");
            showServerErrorModal();
            // –ü—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(setupWebSocket, 5000);
        };
    }
    // –î–æ–±–∞–≤–∏–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    var currentBlockStatus = false;
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —á–∞—Ç–∞
    async function checkBlockStatus() {
        if (!activeChatId) return;

        try {
            const response = await fetch(`http://localhost:3333/service/api/mutual-block?chatId=${activeChatId}`, {
                headers: { 'Authorization': 'Bearer ' + getJwtToken() }
            });
            if (!response.ok) throw new Error('Failed to check block status');

            const data = await response.json();
            currentBlockStatus = data.isMutuallyBlocked;

            const chatInput = document.getElementById('chat-input');
            const blockedMsg = document.getElementById('blocked-message');
            const msgInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-btn');
            const blockBtn = document.getElementById("block-toggle-btn");

            // –û–±–Ω–æ–≤–ª—è–µ–º UI (–ø–æ–ª–µ –≤–≤–æ–¥–∞ –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ)
            if (data.isMutuallyBlocked) {
                chatInput.classList.add('blocked');
                blockedMsg.style.display = 'block';
                msgInput.disabled = true;
                sendButton.disabled = true;
                msgInput.placeholder = '–°–æ–æ–±—â–µ–Ω–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã';
                blockBtn.textContent =  "–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å";
                blockBtn.dataset.isBlocked = "true";
            } else {
                chatInput.classList.remove('blocked');
                blockedMsg.style.display = 'none';
                msgInput.disabled = false;
                sendButton.disabled = false;
                msgInput.placeholder = 'Type a message...';
                blockBtn.textContent =  "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å";
                blockBtn.dataset.isBlocked = "false";
            }


        } catch (error) {
            console.error('Error checking block status:', error);
        }
    }



    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
    function loadChats() {
        fetch('http://localhost:3333/service/api/chats', {
            headers: {
                'Authorization': 'Bearer ' + getJwtToken()
            },
            credentials: "include"
        })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —á–∞—Ç—ã –Ω–∞–ø—Ä—è–º—É—é –∑–¥–µ—Å—å
                if (data.info) {
                    accountInfo = data.info;
                    updateAccountInfo();
                }
                if (data.chats) {
                    chats = data.chats.map(chat => ({
                        id: chat.id,
                        username: chat.name,
                        userPhoto: chat.profile_picture,
                        readed: chat.readed,
                        isPrivate: chat.Private,
                        users: chat.users
                    }));
                    updateChatList();
                    updateChatHeader(); // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –µ—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç
                }
            })
            .catch(error => {
                console.error('Error fetching chats:', error);
                if (error.message.includes('Unauthorized')) {
                    window.location.href = "/login";
                }
            });
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ JWT —Ç–æ–∫–µ–Ω–∞ –∏–∑ cookies
    function getJwtToken() {
        return document.cookie.split('jwt_token=')[1].split(';')[0];
    }
    // –í —Å–µ–∫—Ü–∏—é –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
    document.getElementById("logout-btn").addEventListener("click", function() {
        // –£–¥–∞–ª—è–µ–º –∫—É–∫–∏ —Å —Ç–æ–∫–µ–Ω–æ–º
        document.cookie = "jwt_token=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;";
        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
        window.location.href = "/login";
    });
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
    function handleMessage(data) {
        switch (data.method) {
            case "RcvdMessage":
                var msg = data.data;

                // –ï—Å–ª–∏ —á–∞—Ç –µ—â—ë –Ω–µ –≤—ã–±—Ä–∞–Ω, –∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å activeChatId
                if (!activeChatId) {
                    activeChatId = msg.fromChatID;
                }

                if (msg.fromChatID === activeChatId) {
                    messages.push({
                        id: msg.id,
                        UserFromID: msg.UserFromID,
                        Message: msg.message,
                        timestamp: msg.timestamp,
                        isRead: msg.Readed
                    });
                    updateChatBody();
                } else {
                    // –£–≤–µ–ª–∏—á–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ —á–∞—Ç–∞
                    unreadMessages[msg.fromChatID] = (unreadMessages[msg.fromChatID] || 0) + 1;
                    updateChatList();
                }
                break;
            default:
                console.warn("Unknown method:", data.method);
        }
    }

    function handleChatSelect(chatId) {
        activeChatId = chatId;
        checkBlockStatus();
        
        fetch(`http://localhost:3333/service/api/messages?chatId=${chatId}`, {
            headers: { 'Authorization': 'Bearer ' + getJwtToken() }
        })
            .then(response => response.json())
            .then(data => {
                messages = data.messages.map(msg => ({
                    id: msg.id,
                    UserFromID: msg.from,
                    Message: msg.message,
                    timestamp: msg.timestamp,
                    isRead: msg.readed
                }));

                updateChatBody();
                updateChatHeader(); // –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É

                // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
                fetch(`http://localhost:3333/service/api/messages/read?chatId=${chatId}`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + getJwtToken() }
                });
            })
            .catch(error => console.error('Error:', error));
    }


    async function handleSendMessage() {
        const msg = messageInput.value.trim();
        if (!msg) return;
        console.log("activeChatId",activeChatId,"activeUserId",activeUserId,"msg",msg)

        // –ï—Å–ª–∏ —á–∞—Ç–∞ –Ω–µ—Ç - —Å–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞
        const messageData = activeChatId === -1
            ? { method: "RcvdMessage", query: {chatId: -1, user2: activeUserId, message: msg } }
            : { method: "RcvdMessage", query: { chatId: activeChatId, message: msg } };

        sendToServer(messageData);
        messageInput.value = "";
    }



    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ø–æ–∏—Å–∫–∞
    function handleUserSelect(user) {
        activeUserId = user.id;

        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ —Å—Ä–∞–∑—É, –¥–∞–∂–µ –µ—Å–ª–∏ —á–∞—Ç–∞ –Ω–µ—Ç
        document.getElementById("chat-title").textContent = user.username;
        document.getElementById("chat-user-photo").src = user.profile_picture || "https://via.placeholder.com/40";

        if (user.chat_id) {
            activeChatId = user.chat_id;
            handleChatSelect(activeChatId);
        } else {
            activeChatId = null;
            messages = []; // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            updateChatBody();
        }

        searchInput.value = "";
        searchResults = [];
        updateSearchResults();
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
    // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è updateChatList
    function updateChatList() {
        chatListDiv.innerHTML = "";
        chats.forEach(chat => {
            const chatItem = document.createElement("div");
            chatItem.className = "chat-item";

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ –≤—Å–µ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
            chatItem.addEventListener("click", () => handleChatSelect(chat.id));

            // –ê–≤–∞—Ç–∞—Ä
            const avatar = document.createElement("img");
            avatar.className = "chat-avatar";
            avatar.src = chat.userPhoto || "https://via.placeholder.com/40";

            // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–µ
            const chatInfo = document.createElement("div");
            chatInfo.className = "chat-info";

            const chatName = document.createElement("h3");
            chatName.textContent = chat.username;

            // –°—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
            if (unreadMessages[chat.id] > 0) {
                const unread = document.createElement("span");
                unread.className = "unread-count";
                unread.textContent = unreadMessages[chat.id];
                chatInfo.appendChild(unread);
            }

            // –°–æ–±–∏—Ä–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
            chatInfo.appendChild(chatName);
            chatItem.appendChild(avatar);
            chatItem.appendChild(chatInfo);
            chatListDiv.appendChild(chatItem);
        });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —á–∞—Ç–∞
    function updateChatHeader() {
        if (!activeChatId) return;

        const chat = chats.find(c => c.id === activeChatId);
        if (chat) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            document.getElementById("chat-title").textContent = chat.username;

            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
            const headerAvatar = document.getElementById("chat-user-photo");
            if (headerAvatar) {
                headerAvatar.src = chat.userPhoto || "https://via.placeholder.com/40";
            }
        }
    }
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±–ª–∞—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
    function updateChatBody() {
        chatBody.innerHTML = "";
        const currentUserId = getUserIdFromJWT();

        messages.forEach(message => {
            const messageDiv = document.createElement("div");
            messageDiv.className = `message ${message.UserFromID === currentUserId ? "sent" : "received"}`;

            const msgText = document.createElement("p");
            msgText.className = "message-text";
            msgText.textContent = message.Message;

            const msgMeta = document.createElement("span");
            msgMeta.className = "message-meta";
            msgMeta.textContent = new Date(message.timestamp).toLocaleString("ru-RU");

            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—á—Ç–µ–Ω–∏—è –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            if (message.UserFromID === currentUserId) {
                const statusSpan = document.createElement("span");
                statusSpan.className = `status-icon ${message.isRead ? "read" : "unread"}`;
                statusSpan.textContent = message.isRead ? "‚úì‚úì" : "‚úì";
                msgMeta.appendChild(statusSpan);
            }

            messageDiv.appendChild(msgText);
            messageDiv.appendChild(msgMeta);
            chatBody.appendChild(messageDiv);
        });

        chatBody.scrollTop = chatBody.scrollHeight;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
    function updateSearchResults() {
        searchResultsDiv.innerHTML = "";
        const currentUserId = getUserIdFromJWT();

        searchResults
            .filter(user => user.id.toString() !== currentUserId)
            .forEach(user => {
                const item = document.createElement("div");
                item.className = "search-result-item";
                item.innerHTML = `
                <img src="${user.profile_picture || 'https://via.placeholder.com/40'}"
                     class="search-result-avatar">
                <span>${user.username}</span>
                ${user.chat_id === -1 ? `<span class="existing-chat-badge">–ß–∞—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç</span>` : '<span class="existing-chat-badge">–ß–∞—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç</span>'}
            `;
                item.addEventListener("click", () => handleUserSelect(user));
                searchResultsDiv.appendChild(item);
            });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ
    function updateAccountInfo() {
        accountStripImg.src = accountInfo.ProfilePicture || "https://via.placeholder.com/40";
        accountStripName.textContent = accountInfo.UserName || "User";
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener("load", function() {
        setupWebSocket();

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ Enter
        messageInput.addEventListener("keypress", function(e) {
            if (e.key === "Enter") {
                handleSendMessage();
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
        sendBtn.addEventListener("click", handleSendMessage);

        // –î–µ–±–∞—É–Ω—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ –ø–æ–∏—Å–∫–∞
        let debounceTimer;
        searchInput.addEventListener("input", function() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const query = this.value.trim();
                if (query) {
                    fetch(`http://localhost:3333/service/api/users?username=${encodeURIComponent(query)}`, {
                        headers: {
                            'Authorization': 'Bearer ' + getJwtToken()
                        },
                        credentials: "include"
                    })
                        .then(response => response.json())
                        .then(users => {
                            searchResults = users; // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞–ø—Ä—è–º—É—é
                            updateSearchResults();
                        })
                        .catch(error => console.error('Search error:', error));
                } else {
                    searchResults = [];
                    updateSearchResults();
                }
            }, 500);
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞
        // chatHeader.addEventListener("click", function() {
        //     if (activeChatId) {
        //         const chat = chats.find(c => c.id === activeChatId);
        //         if (chat) {
        //             // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
        //             document.getElementById("chat-info-img").src = chat.userPhoto || "https://via.placeholder.com/150";
        //             document.getElementById("chat-info-username").textContent = chat.username;
        //
        //             // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        //             document.getElementById("chat-info-modal").style.display = "flex";
        //         }
        //     }
        // });
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        chatInfoClose.addEventListener("click", function(e) {
            e.stopPropagation();
            chatInfoModal.style.display = "none";
        });

        accountInfoClose.addEventListener("click", function(e) {
            e.stopPropagation();
            accountInfoModal.style.display = "none";
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –ø–∞–Ω–µ–ª—å –∞–∫–∫–∞—É–Ω—Ç–∞
        accountStrip.addEventListener("click", function() {
            accountInfoImg.src = accountInfo.ProfilePicture || "https://via.placeholder.com/150";
            document.getElementById("view-mail").textContent = accountInfo.Mail || "";
            document.getElementById("view-username").textContent = accountInfo.UserName || "";
            document.getElementById("view-bio").textContent = accountInfo.Biom || "";
            document.getElementById("account-info-view").style.display = "block";
            document.getElementById("account-info-edit").style.display = "none";
            accountInfoModal.style.display = "flex";
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
        document.getElementById("edit-profile-btn").addEventListener("click", function() {
            document.getElementById("account-info-view").style.display = "none";
            document.getElementById("account-info-edit").style.display = "block";
            document.getElementById("edit-mail").value = accountInfo.Mail || "";
            document.getElementById("edit-username").value = accountInfo.UserName || "";
            document.getElementById("edit-bio").value = accountInfo.Biom || "";
        });

        document.getElementById("cancel-edit-btn").addEventListener("click", function() {
            document.getElementById("account-info-view").style.display = "block";
            document.getElementById("account-info-edit").style.display = "none";
        });

        document.getElementById("save-profile-btn").addEventListener("click", function() {
            const updated = {
                Mail: document.getElementById("edit-mail").value.trim(),
                UserName: document.getElementById("edit-username").value.trim(),
                Biom: document.getElementById("edit-bio").value.trim()
            };

            fetch('http://localhost:3333/service/api/profile', {
                method: 'PUT',
                credentials: "include",
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + getJwtToken()
                },
                body: JSON.stringify(updated)
            })
                .then(response => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∏ –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–µ–ª–æ –æ—Ç–≤–µ—Ç–∞
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        return response.json();
                    }
                    return null; // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –ø—É—Å—Ç–æ–π
                })
                .then(data => {
                    accountInfo = {...accountInfo, ...updated};
                    updateAccountInfo();
                    accountInfoModal.style.display = "none";

                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                    document.getElementById("view-mail").textContent = updated.Mail;
                    document.getElementById("view-username").textContent = updated.UserName;
                    document.getElementById("view-bio").textContent = updated.Biom;
                })
                .catch(error => {
                    console.error('Error updating profile:', error);
                    alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.");
                });
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–º–µ–Ω—ã —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è
        document.getElementById("change-photo-btn").addEventListener("click", function() {
            document.getElementById("file-input").click();
        });

        document.getElementById("file-input").addEventListener("change", function(e) {
            var file = e.target.files[0];
            if (file) {
                compressImage(file, function(compressedDataUrl) {
                    fetch('http://localhost:3333/service/api/profile/photo', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + getJwtToken()
                        },
                        credentials: "include",
                        body: JSON.stringify({
                            imageData: compressedDataUrl
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.ProfilePicture) {
                                accountInfo.ProfilePicture = data.ProfilePicture;
                                updateAccountInfo();
                            }
                        })
                        .catch(error => console.error('Error updating profile picture:', error));
                });
            }
        });
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ—à–∏–±–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
    document.getElementById("server-error-close").addEventListener("click", function() {
        serverErrorModal.style.display = "none";
    });

</script>
</body>
</html>
